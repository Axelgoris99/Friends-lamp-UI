<script lang="ts">
	import ColorPicker from 'svelte-awesome-color-picker';
	import { currentUser, pb } from '$lib/pocketbase';

	let hex: string = $currentUser?.color; // or hsv or rgb (need RgbaColor type)
	let finishedTouching: boolean;
	let message: string = $currentUser?.message;
	let timeOut: NodeJS.Timeout;

	/// Makes the app freezes forever, trapped in a somewhat infinite loop I think...
	//$: message = $currentUser?.message;
	//$: hex = $currentUser?.color;

	async function checkForChangeAfterNSeconds(time: number) {
		if (!$currentUser) {
			alert("Tu dois te connecter d'abord !");
			return;
		}
		if (timeOut) clearTimeout(timeOut);
		async function writeToPB() {
			const data = {
				color: hex
			};
			try {
				const record = await pb.collection('users').update($currentUser.id, data);
			} catch {
				alert('Ca a merdé quelque part...');
				return;
			}
		}
		timeOut = setTimeout(writeToPB, time);
	}

	function changeColor() {
		finishedTouching = false;
		checkForChangeAfterNSeconds(1000);
	}

	async function changeMessage() {
		if (!$currentUser) {
			alert("Tu dois te connecter d'abord !");
			return;
		}
		const data = {
			message: message
		};
		try {
			const record = await pb.collection('users').update($currentUser.id, data);
		} catch {
			alert('Ca a merdé quelque part...');
			return;
		}
	}
</script>

<div class="container h-full mx-auto flex justify-center items-center">
	<div class="space-y-10 text-center flex flex-col items-center">
		<h2 class="h2">Bienvenue sur l'interface de gestion de ta lampe !</h2>
		<!-- Animated Logo -->
		<figure>
			<section class="img-bg" />
			<svg
				xmlns="http://www.w3.org/2000/svg"
				xmlns:xlink="http://www.w3.org/1999/xlink"
				width="500"
				zoomAndPan="magnify"
				viewBox="0 0 375 374.999991"
				height="500"
				preserveAspectRatio="xMidYMid meet"
				version="1.0"
				class="fill-blue-500"
				><defs
					><clipPath id="4a8a9d2caa"
						><path
							d="M 79.078125 18.75 L 295.828125 18.75 L 295.828125 282 L 79.078125 282 Z M 79.078125 18.75 "
							clip-rule="nonzero"
						/></clipPath
					><clipPath id="1d63006df7"
						><path
							d="M 172 342 L 187 342 L 187 356.25 L 172 356.25 Z M 172 342 "
							clip-rule="nonzero"
						/></clipPath
					></defs
				><path
					fill={hex}
					d="M 200.484375 281.070312 L 186.578125 281.070312 L 186.578125 275.691406 L 195.109375 275.691406 L 195.109375 233.921875 L 235.085938 193.925781 L 235.085938 119.847656 L 184.113281 68.847656 L 184.113281 21.433594 L 189.484375 21.433594 L 189.484375 66.625 L 240.464844 117.625 L 240.464844 196.152344 L 200.484375 236.148438 L 200.484375 281.070312 "
					fill-opacity="1"
					fill-rule="nonzero"
				/><path
					fill={hex}
					d="M 182.988281 281.070312 L 166.246094 281.070312 L 166.246094 275.691406 L 177.613281 275.691406 L 177.613281 217.960938 L 151.890625 192.226562 L 151.890625 140.222656 L 177.742188 114.359375 L 211.4375 148.074219 L 211.4375 185.980469 L 206.0625 185.980469 L 206.0625 150.296875 L 177.742188 121.96875 L 157.265625 142.449219 L 157.265625 190 L 182.988281 215.730469 L 182.988281 281.070312 "
					fill-opacity="1"
					fill-rule="nonzero"
				/><g clip-path="url(#4a8a9d2caa)"
					><path
						fill={hex}
						d="M 245.238281 281.070312 L 207.710938 281.070312 L 207.710938 255.609375 L 225.984375 237.332031 L 229.78125 241.132812 L 213.085938 257.839844 L 213.085938 275.691406 L 239.867188 275.691406 C 240.011719 244.390625 250.308594 214.300781 269.652344 188.628906 C 283.15625 170.714844 290.289062 149.347656 290.289062 126.851562 C 290.289062 70.210938 244.230469 24.125 187.609375 24.121094 C 131.632812 24.121094 85.570312 69.667969 84.933594 125.652344 C 84.671875 148.746094 91.894531 170.636719 105.816406 188.960938 C 124.726562 213.839844 135.199219 244.617188 135.351562 275.691406 L 150.339844 275.691406 L 150.339844 226.460938 L 131.398438 206.617188 L 131.398438 166.914062 L 110.683594 144.398438 L 110.683594 84.328125 L 116.058594 84.328125 L 116.058594 142.300781 L 136.773438 164.820312 L 136.773438 204.460938 L 155.710938 224.304688 L 155.710938 281.070312 L 129.980469 281.070312 L 129.980469 276.367188 C 129.980469 246.234375 119.878906 216.34375 101.539062 192.214844 C 86.882812 172.929688 79.285156 149.894531 79.5625 125.589844 C 79.886719 96.875 91.257812 69.996094 111.582031 49.902344 C 131.898438 29.8125 158.902344 18.746094 187.609375 18.746094 C 247.191406 18.75 295.664062 67.242188 295.664062 126.851562 C 295.664062 150.527344 288.15625 173.011719 273.945312 191.863281 C 255.164062 216.78125 245.238281 246.007812 245.238281 276.375 L 245.238281 281.070312 "
						fill-opacity="1"
						fill-rule="nonzero"
					/></g
				><path
					fill={hex}
					d="M 138.566406 135.257812 L 133.191406 135.257812 L 133.191406 97.390625 L 155.046875 75.527344 L 155.046875 45.90625 L 160.417969 45.90625 L 160.417969 77.753906 L 138.566406 99.617188 L 138.566406 135.257812 "
					fill-opacity="1"
					fill-rule="nonzero"
				/><path
					fill={hex}
					d="M 272.980469 157.972656 L 267.609375 157.972656 L 267.609375 118.992188 L 228.683594 80.054688 L 228.683594 48.445312 L 234.058594 48.445312 L 234.058594 77.828125 L 272.980469 116.769531 L 272.980469 157.972656 "
					fill-opacity="1"
					fill-rule="nonzero"
				/><path
					fill={hex}
					d="M 215.714844 186.609375 C 215.714844 190.457031 212.597656 193.578125 208.75 193.578125 C 204.902344 193.578125 201.789062 190.457031 201.789062 186.609375 C 201.789062 182.761719 204.902344 179.644531 208.75 179.644531 C 212.597656 179.644531 215.714844 182.761719 215.714844 186.609375 "
					fill-opacity="1"
					fill-rule="nonzero"
				/><path
					fill={hex}
					d="M 186.578125 218.09375 C 186.578125 221.941406 183.460938 225.0625 179.613281 225.0625 C 175.769531 225.0625 172.648438 221.941406 172.648438 218.09375 C 172.648438 214.246094 175.769531 211.125 179.613281 211.125 C 183.460938 211.125 186.578125 214.246094 186.578125 218.09375 "
					fill-opacity="1"
					fill-rule="nonzero"
				/><path
					fill={hex}
					d="M 184.644531 121.285156 C 184.644531 125.132812 181.527344 128.253906 177.679688 128.253906 C 173.835938 128.253906 170.714844 125.132812 170.714844 121.285156 C 170.714844 117.4375 173.835938 114.316406 177.679688 114.316406 C 181.527344 114.316406 184.644531 117.4375 184.644531 121.285156 "
					fill-opacity="1"
					fill-rule="nonzero"
				/><path
					fill={hex}
					d="M 159.839844 226.742188 C 159.839844 230.589844 156.71875 233.707031 152.871094 233.707031 C 149.027344 233.707031 145.910156 230.589844 145.910156 226.742188 C 145.910156 222.894531 149.027344 219.773438 152.871094 219.773438 C 156.71875 219.773438 159.839844 222.894531 159.839844 226.742188 "
					fill-opacity="1"
					fill-rule="nonzero"
				/><path
					fill={hex}
					d="M 277.261719 159.082031 C 277.261719 162.929688 274.140625 166.050781 270.292969 166.050781 C 266.449219 166.050781 263.335938 162.929688 263.335938 159.082031 C 263.335938 155.234375 266.449219 152.117188 270.292969 152.117188 C 274.140625 152.117188 277.261719 155.234375 277.261719 159.082031 "
					fill-opacity="1"
					fill-rule="nonzero"
				/><path
					fill={hex}
					d="M 243.847656 118.164062 C 243.847656 122.011719 240.726562 125.132812 236.878906 125.132812 C 233.035156 125.132812 229.917969 122.011719 229.917969 118.164062 C 229.917969 114.316406 233.035156 111.195312 236.878906 111.195312 C 240.726562 111.195312 243.847656 114.316406 243.847656 118.164062 "
					fill-opacity="1"
					fill-rule="nonzero"
				/><path
					fill={hex}
					d="M 243.847656 193.875 C 243.847656 197.726562 240.726562 200.84375 236.878906 200.84375 C 233.035156 200.84375 229.917969 197.726562 229.917969 193.875 C 229.917969 190.027344 233.035156 186.910156 236.878906 186.910156 C 240.726562 186.910156 243.847656 190.027344 243.847656 193.875 "
					fill-opacity="1"
					fill-rule="nonzero"
				/><path
					fill={hex}
					d="M 193.539062 67.019531 C 193.539062 70.867188 190.425781 73.988281 186.578125 73.988281 C 182.734375 73.988281 179.613281 70.867188 179.613281 67.019531 C 179.613281 63.171875 182.734375 60.054688 186.578125 60.054688 C 190.425781 60.054688 193.539062 63.171875 193.539062 67.019531 "
					fill-opacity="1"
					fill-rule="nonzero"
				/><path
					fill={hex}
					d="M 238.335938 50.453125 C 238.335938 54.300781 235.214844 57.417969 231.371094 57.417969 C 227.527344 57.417969 224.40625 54.300781 224.40625 50.453125 C 224.40625 46.605469 227.527344 43.484375 231.371094 43.484375 C 235.214844 43.484375 238.335938 46.605469 238.335938 50.453125 "
					fill-opacity="1"
					fill-rule="nonzero"
				/><path
					fill={hex}
					d="M 234.84375 238.882812 C 234.84375 242.730469 231.726562 245.851562 227.882812 245.851562 C 224.035156 245.851562 220.914062 242.730469 220.914062 238.882812 C 220.914062 235.035156 224.035156 231.914062 227.882812 231.914062 C 231.726562 231.914062 234.84375 235.035156 234.84375 238.882812 "
					fill-opacity="1"
					fill-rule="nonzero"
				/><path
					fill={hex}
					d="M 206.167969 233.707031 C 206.167969 237.554688 203.046875 240.675781 199.199219 240.675781 C 195.355469 240.675781 192.234375 237.554688 192.234375 233.707031 C 192.234375 229.859375 195.355469 226.742188 199.199219 226.742188 C 203.046875 226.742188 206.167969 229.859375 206.167969 233.707031 "
					fill-opacity="1"
					fill-rule="nonzero"
				/><path
					fill={hex}
					d="M 120.429688 84.445312 C 120.429688 88.292969 117.3125 91.40625 113.464844 91.40625 C 109.621094 91.40625 106.503906 88.292969 106.503906 84.445312 C 106.503906 80.597656 109.621094 77.476562 113.464844 77.476562 C 117.3125 77.476562 120.429688 80.597656 120.429688 84.445312 "
					fill-opacity="1"
					fill-rule="nonzero"
				/><path
					fill={hex}
					d="M 143.941406 135.257812 C 143.941406 139.105469 140.824219 142.222656 136.976562 142.222656 C 133.128906 142.222656 130.011719 139.105469 130.011719 135.257812 C 130.011719 131.410156 133.128906 128.289062 136.976562 128.289062 C 140.824219 128.289062 143.941406 131.410156 143.941406 135.257812 "
					fill-opacity="1"
					fill-rule="nonzero"
				/><path
					fill={hex}
					d="M 164.695312 45.90625 C 164.695312 49.75 161.578125 52.871094 157.730469 52.871094 C 153.886719 52.871094 150.769531 49.75 150.769531 45.90625 C 150.769531 42.054688 153.886719 38.9375 157.730469 38.9375 C 161.578125 38.9375 164.695312 42.054688 164.695312 45.90625 "
					fill-opacity="1"
					fill-rule="nonzero"
				/><path
					fill={hex}
					d="M 201.886719 352.125 L 179.613281 352.125 L 179.613281 346.75 L 196.511719 346.75 L 196.511719 335.335938 L 158.855469 335.335938 L 158.855469 312.648438 L 229.578125 312.648438 L 229.578125 298 L 136.976562 298 L 136.976562 292.625 L 234.953125 292.625 L 234.953125 318.023438 L 164.230469 318.023438 L 164.230469 329.960938 L 201.886719 329.960938 L 201.886719 352.125 "
					fill-opacity="1"
					fill-rule="nonzero"
				/><path
					fill={hex}
					d="M 145.910156 295.3125 C 145.910156 299.160156 142.792969 302.277344 138.945312 302.277344 C 135.097656 302.277344 131.980469 299.160156 131.980469 295.3125 C 131.980469 291.464844 135.097656 288.34375 138.945312 288.34375 C 142.792969 288.34375 145.910156 291.464844 145.910156 295.3125 "
					fill-opacity="1"
					fill-rule="nonzero"
				/><g clip-path="url(#1d63006df7)"
					><path
						fill={hex}
						d="M 186.578125 349.285156 C 186.578125 353.132812 183.460938 356.25 179.613281 356.25 C 175.769531 356.25 172.648438 353.132812 172.648438 349.285156 C 172.648438 345.4375 175.769531 342.316406 179.613281 342.316406 C 183.460938 342.316406 186.578125 345.4375 186.578125 349.285156 "
						fill-opacity="1"
						fill-rule="nonzero"
					/></g
				></svg
			>
			<!-- <img class="h-auto max-w-xs" src="/images/wLightBulb.png" alt="Lightbulb image" /> -->
		</figure>
		<!-- / -->
		<h3>Choisis une couleur pour ta lampe 🌈</h3>
		<ColorPicker bind:hex label="" isInput={false} isTextInput={false} on:input={changeColor} />

		<h3>Choisis un message pour ta lampe 💬</h3>
		<input
			bind:value={message}
			class="input"
			type="text"
			placeholder="Message"
			on:change={changeMessage}
		/>
		<div class="space-y-2">
			<p>Bon anniversaire Jerem ♥</p>
		</div>
	</div>
</div>

<style lang="postcss">
	figure {
		@apply flex relative flex-col;
	}
	figure svg,
	.img-bg {
		@apply w-64 h-64 md:w-80 md:h-80;
	}
	.img-bg {
		@apply absolute z-[-1] rounded-full blur-[50px] transition-all;
		animation: pulse 5s cubic-bezier(0, 0, 0, 0.5) infinite, glow 5s linear infinite;
	}
	@keyframes glow {
		0% {
			background-color: #dfd2d2;
		}
		33% {
			background-color: #c9d7d9;
		}
		66% {
			background-color: #9bb1b6;
		}
		100% {
			background-color: #dfd2d2;
		}
	}
	@keyframes pulse {
		50% {
			transform: scale(1.5);
		}
	}
</style>
